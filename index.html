<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>OrthoPod Scanner</title>
<link rel="manifest" href="./manifest.webmanifest">
<meta name="theme-color" content="#0b0f14">
<style>
  :root{{ --bg:#0b0f14; --panel:#0f1720; --border:#223042; --text:#e5eef9; --muted:#9fb2c7; --accent:#4ea3ff; --ok:#19c37d; --warn:#ff5e57; }}
  *{{box-sizing:border-box}}
  html,body{{height:100%}}
  body{{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}}
  header{{padding:20px 16px;background:var(--panel);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10}}
  h1{{margin:0;font-size:22px;letter-spacing:.3px;text-align:center}}
  main{{padding:18px;display:grid;gap:16px;max-width:560px;margin:0 auto}}
  .stack{{display:grid;gap:14px}}
  .btn{{appearance:none;border:1px solid var(--border);background:#142034;color:var(--text);padding:16px;border-radius:14px;font-weight:900;cursor:pointer;font-size:18px}}
  .btn.ok{{background:#12261c;border-color:#1e3a2f;color:#7ff0bb}}
  .btn.warn{{background:#2a1520;border-color:#57233a;color:#ff6b8b}}
  .hidden{{display:none !important}}
  .card{{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:14px}}
  #view{{position:relative;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#000}}
  video{{display:block;width:100%;max-height:62vh;transform:scaleX(1)}}
  #overlay{{position:absolute;inset:0;pointer-events:none}}
  #overlay:after{{content:'';position:absolute;left:15%;top:12%;right:15%;bottom:12%;border:2px solid rgba(255,255,255,0.95);border-radius:12px;box-shadow:0 0 0 9999px rgba(0,0,0,.35) inset}}
  .row{{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}}
  .pill{{font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}}
  .toggle{{display:flex;align-items:center;gap:8px}}
  .switch{{position:relative;width:52px;height:30px;border-radius:999px;background:#223042;border:1px solid #2b3d52;cursor:pointer}}
  .switch input{{opacity:0;width:0;height:0}}
  .knob{{position:absolute;top:3px;left:3px;width:24px;height:24px;background:#fff;border-radius:50%;transition:transform .2s}}
  .switch input:checked + .knob{{transform:translateX(22px)}}
  #diag{{font-size:12px;color:#9fb2c7;min-height:16px}}
  #qty{{width:100px;background:#0a131f;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px}}
</style>
</head>
<body>
<header><h1>OrthoPod Scanner</h1></header>

<main>
  <!-- Home -->
  <section id="home" class="stack">
    <button class="btn" id="btnOrder">Order</button>
    <button class="btn ok" id="btnReceive">Receive</button>
    <button class="btn warn" id="btnUse">Use</button>
    <div id="diag"></div>
  </section>

  <!-- Scanner -->
  <section id="scan" class="hidden">
    <div class="card stack">
      <div class="row">
        <div class="row" style="gap:10px">
          <button id="back" class="btn">Back</button>
          <select id="camera" style="background:#0a131f;color:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px"></select>
          <label>Qty <input id="qty" type="number" value="1" min="1"></label>
        </div>
        <div class="row" style="gap:10px">
          <div class="toggle">
            <label class="switch">
              <input id="continuous" type="checkbox" checked><span class="knob"></span>
            </label>
            <span class="pill">Continuous</span>
          </div>
          <button id="torch" class="btn">Torch</button>
          <span id="decoderTag" class="pill">Decoder: ?</span>
          <span id="status" class="pill">Starting…</span>
        </div>
      </div>
      <div id="view">
        <video id="video" playsinline autoplay muted webkit-playsinline></video>
        <canvas id="canvas" class="hidden"></canvas>
        <div id="overlay"></div>
      </div>
      <div class="row" style="gap:10px">
        <button id="actOrder" class="btn">Order</button>
        <button id="actReceive" class="btn ok">Receive</button>
        <button id="actUse" class="btn warn">Use</button>
      </div>
    </div>
  </section>
</main>

<script>
  // Firebase config (free tier)
  const firebaseConfig = {"apiKey":"AIzaSyB0w25u3Ys1SyE2Xm0waLHNlUcqOKbQdIw","authDomain":"inventory-67ceb.firebaseapp.com","projectId":"inventory-67ceb","storageBucket":"inventory-67ceb.firebasestorage.app","messagingSenderId":"1031351285804","appId":"1:1031351285804:web:cee68e7047fc8ef76c7989","measurementId":"G-C5G29GW4PZ"};
</script>

<!-- Firebase (modules) -->
<script type="module">
  import {{ initializeApp }} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {{ getAuth, signInAnonymously }} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {{ getFirestore, collection, addDoc, updateDoc, getDoc, getDocs, query, where, doc, serverTimestamp }} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  async function ensureAuth(){{ try{{ await signInAnonymously(auth); }}catch(e){{ console.warn('auth', e); }} }}

  const INV  = 'inventoryProducts';
  const ORD  = 'orders';
  const DEL  = 'deliveries';
  const ADJ  = 'stockAdjustments';

  const $ = s => document.querySelector(s);
  const home = $('#home');
  const scan = $('#scan');
  const btnOrder = $('#btnOrder');
  const btnReceive = $('#btnReceive');
  const btnUse = $('#btnUse');
  const btnBack = $('#back');
  const camSel = $('#camera');
  const statusEl = $('#status');
  const decoderTag = $('#decoderTag');
  const torchBtn = $('#torch');
  const chkCont = $('#continuous');
  const qtyEl = $('#qty');
  const video = $('#video');
  const canvas = $('#canvas');
  const ctx = canvas.getContext('2d', {{ willReadFrequently: true }});
  const diag = document.getElementById('diag');

  const btnActOrder = $('#actOrder');
  const btnActReceive = $('#actReceive');
  const btnActUse = $('#actUse');

  let mode='order';
  let stream=null, track=null, scanning=false, detector=null, useBD=('BarcodeDetector' in window);
  let lastText=null, decodeTimer=null, lastProduct=null;

  function writeDiag(msg){{ diag.textContent = msg; }}
  function showHome(){{ home.classList.remove('hidden'); scan.classList.add('hidden'); }}
  function showScan(){{ home.classList.add('hidden'); scan.classList.remove('hidden'); }}
  function setStatus(t){{ statusEl.textContent=t; }}

  async function listCameras(){{ try{{ const devs = await navigator.mediaDevices.enumerateDevices(); const vids = devs.filter(d=>d.kind==='videoinput'); camSel.innerHTML = vids.map(d=>`<option value="${{d.deviceId}}">${{d.label || 'Camera '+(vids.indexOf(d)+1)}}</option>`).join(''); }}catch(e){{}} }}

  async function startCamera(){{
    try{{
      const constraints = {{ video: {{ facingMode: {{ ideal:'environment' }}, advanced:[{{ facingMode:'environment' }}, {{ focusMode:'continuous' }}], deviceId: camSel.value ? {{ exact: camSel.value }} : undefined, width: {{ ideal:1920 }}, height: {{ ideal:1080 }} }}, audio:false }};
      if (!window.isSecureContext){{ writeDiag('Serve over HTTPS (or localhost) for camera.'); }}
      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream; await video.play();
      track = stream.getVideoTracks()[0];
      try{{ const caps = track.getCapabilities?.() || {{}}; if(caps.torch && torchBtn) torchBtn.disabled = false; }}catch{{}}
      scanning = true; setStatus('Scanning…');
      if(useBD){{ try{{ detector = new BarcodeDetector({{formats:['qr_code','code_128','ean_13','ean_8','code_39','data_matrix']}}); decoderTag.textContent='Decoder: BarcodeDetector'; }}catch{{ useBD=false; }} }}
      if(!useBD) decoderTag.textContent='Decoder: jsQR (loading…)';
      await listCameras();
      loopStart();
    }}catch(err){{ console.error(err); setStatus('Camera blocked'); writeDiag((err && (err.name+': '+err.message)) || 'Camera access failed. Permission?'); alert('Camera access failed. Use HTTPS (or localhost) and allow camera.'); }}
  }}
  function stopDecodingTimers(){{ if(decodeTimer){{clearInterval(decodeTimer); decodeTimer=null;}} }}
  async function stopCamera(){{ scanning=false; stopDecodingTimers(); if(track){{ try{{ track.stop(); }}catch{{}} }} if(stream){{ stream.getTracks().forEach(t=>t.stop()); }} stream=null; track=null; detector=null; }}

  function loopStart(){{ stopDecodingTimers(); decodeTimer = setInterval(async ()=>{{ if(!scanning) return; const txt = await decodeFrame(); if (txt && txt !== lastText){{ lastText = txt; setStatus('Decoded'); await onDecoded(txt); if(!chkCont.checked){{ await stopCamera(); showHome(); }} else {{ setTimeout(()=>setStatus('Scanning…'), 250); }} }} }}, 180); }}

  async function decodeFrame(){{ const vw=video.videoWidth, vh=video.videoHeight; if(!vw||!vh) return null; const roi={{ x:Math.floor(vw*0.15), y:Math.floor(vh*0.12), w:Math.floor(vw*0.70), h:Math.floor(vh*0.76) }}; canvas.width=roi.w; canvas.height=roi.h; ctx.imageSmoothingEnabled=false; ctx.drawImage(video, roi.x, roi.y, roi.w, roi.h, 0, 0, roi.w, roi.h); if(useBD && detector){{ try{{ const bmp = await createImageBitmap(canvas); const codes = await detector.detect(bmp); if(codes && codes.length) return codes[0].rawValue; }}catch{{}} }} if(!(await ensureJsQR())){{ decoderTag.textContent='Decoder: jsQR (failed to load)'; return null; }} if (decoderTag.textContent.indexOf('jsQR')===-1) decoderTag.textContent='Decoder: jsQR'; const img = ctx.getImageData(0,0,canvas.width,canvas.height); const qr = window.jsQR(img.data, img.width, img.height, {{ inversionAttempts:'attemptBoth' }}); return (qr && qr.data) || null; }}

  function normalizeText(t){{ try{{ return t.trim(); }}catch{{ return t; }} }}
  async function lookupProduct(payload){{ let id=null, sku=null; try{{ const j=JSON.parse(payload); id=j.id||null; sku=j.sku||null; }}catch{{ sku=normalizeText(payload); }} let p=null; if(id){{ const ref=doc(db, INV, id); const snap=await getDoc(ref); if(snap.exists()) p={{ id:snap.id, ...snap.data() }}; }} if(!p && sku){{ const qy=query(collection(db, INV), where('sku','==', sku)); const qs=await getDocs(qy); if(!qs.empty){{ const d=qs.docs[0]; p={{ id:d.id, ...d.data() }}; }} }} return p; }}

  async function onDecoded(payload){{ if(!auth.currentUser) await ensureAuth(); const qty=Math.max(1, Number(qtyEl.value||1)); lastProduct=await lookupProduct(payload); if(!lastProduct){{ writeDiag('No product matched. (Ensure QR encodes id or sku)'); return; }} if(mode==='order'){{ await addDoc(collection(db, ORD), {{ productId:lastProduct.id, supplier:lastProduct.supplier||'', system:lastProduct.system||lastProduct.category||'', productName:lastProduct.productName||'', sku:lastProduct.sku||'', qty, orderedBy:'(scanner)', po:'', notes:'OrthoPod Scanner PWA', orderedAt: Date.now(), createdAt: serverTimestamp() }}); navigator.vibrate && navigator.vibrate(60); }} else if(mode==='receive'){{ const newStock=Math.max(0, Number(lastProduct.stock||0)+qty); await updateDoc(doc(db, INV, lastProduct.id), {{ stock:newStock, updatedAt: Date.now(), lastChecked: Date.now() }}); await addDoc(collection(db, DEL), {{ productId:lastProduct.id, supplier:lastProduct.supplier||'', system:lastProduct.system||lastProduct.category||'', productName:lastProduct.productName||'', sku:lastProduct.sku||'', qty, po:'', ref:'OrthoPod Scanner PWA', receivedBy:'(scanner)', createdAt: serverTimestamp() }}); navigator.vibrate && navigator.vibrate(60); lastProduct.stock=newStock; }} else {{ const newStock=Math.max(0, Number(lastProduct.stock||0)-qty); await updateDoc(doc(db, INV, lastProduct.id), {{ stock:newStock, updatedAt: Date.now(), lastChecked: Date.now() }}); await addDoc(collection(db, ADJ), {{ productId:lastProduct.id, delta:-qty, note:'OrthoPod Scanner PWA', at: serverTimestamp() }}); navigator.vibrate && navigator.vibrate([60,40,60]); lastProduct.stock=newStock; }} }}

  btnOrder.addEventListener('click', async ()=>{{ mode='order'; showScan(); await ensureAuth(); await startCamera(); }});
  btnReceive.addEventListener('click', async ()=>{{ mode='receive'; showScan(); await ensureAuth(); await startCamera(); }});
  btnUse.addEventListener('click', async ()=>{{ mode='use'; showScan(); await ensureAuth(); await startCamera(); }});
  btnBack.addEventListener('click', async ()=>{{ await stopCamera(); showHome(); }});
  camSel.addEventListener('change', async ()=>{{ if(stream){{ await stopCamera(); await startCamera(); }} }});
  torchBtn.addEventListener('click', async ()=>{{ if(!track?.getCapabilities) return; const caps=track.getCapabilities(); if(!caps.torch) return; const settings=track.getSettings(); const next=!settings.torch; try{{ await track.applyConstraints({{ advanced:[{{ torch: next }}] }}); }}catch{{}} }});

  if('serviceWorker' in navigator){{ navigator.serviceWorker.register('./sw.js').catch(()=>{{}}); }}
  (async ()=>{{ await ensureAuth(); if(navigator.mediaDevices?.enumerateDevices) await listCameras(); }})();
</script>

<script>
  let jsQRReady=false;
  function ensureJsQR(){{ return new Promise((resolve)=>{{ if (window.jsQR){{ jsQRReady=true; return resolve(true); }} const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js'; s.onload=()=>{{ jsQRReady=true; resolve(true); }}; s.onerror=()=>resolve(false); document.head.appendChild(s); }}); }}
</script>

</body>
</html>
